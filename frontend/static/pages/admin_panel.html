<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Admin Panel</title>
  <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon-32x32.png">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://unpkg.com/htmx.org@1.9.10"></script>
  <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.14.3/dist/cdn.min.js" defer></script>
  <link rel="stylesheet" href="/static/css/styles.css">
  <script src="/static/js/app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
  <script src="/static/js/email_service.js"></script>
</head>
<body x-data="panel()" x-init="init()" @auth:changed.window="logged = !!icp.state.token; if(logged) startTimer();">
  <!-- Page Loader -->
  <div id="global-loader" class="page-loader">
    <div class="loader-spinner"></div>
    <div class="loader-text">Loading Admin Portal...</div>
  </div>
  <nav class="navbar navbar-dark glass-nav">
    <div class="container d-flex align-items-center">
      <div class="d-flex align-items-center gap-3">
        <a class="navbar-brand" href="/">ICP Admin</a>
        <a class="btn btn-outline-warning btn-sm" href="/static/pages/admin.html" x-show="!icp.state.token">Admin Login</a>
      </div>
      <div class="ms-auto d-flex align-items-center gap-2">
        <!-- Web Account Dropdown -->
        <div class="dropdown d-none d-md-inline-block" x-show="!!icp.state.token">
          <button class="btn btn-outline-light btn-sm dropdown-toggle px-3" type="button" data-bs-toggle="dropdown" aria-expanded="false">
            <i class="bi bi-person-circle me-1"></i>
            Account
          </button>
          <ul class="dropdown-menu dropdown-menu-end shadow-lg border-0 glass-card mt-2">
            <li class="px-3 py-2">
              <div class="fw-bold text-primary small text-uppercase mb-1">Admin Role</div>
              <div class="text-white fw-semibold" x-text="userName"></div>
              <div class="text-secondary small" x-text="userEmail"></div>
            </li>
          </ul>
        </div>
        
        <span class="text-secondary d-none d-md-inline-block mx-1" x-show="!!icp.state.token">|</span>
        
        <button class="btn btn-outline-danger btn-sm" onclick="icp.logout()" x-show="!!icp.state.token">Logout</button>
      </div>
    </div>
  </nav>

  <!-- Admin Session Timer Display - Only show when 1 minute left -->
  <div class="session-timer-badge" x-show="logged && sessionTime > 0 && sessionTime <= 60" x-transition x-cloak>
    <i class="bi bi-shield-lock" :class="sessionTime <= 30 ? 'timer-critical' : ''"></i>
    <span>Admin Session: <span x-text="formatTime(sessionTime)"></span></span>
    <span class="ms-2 small text-warning" x-show="sessionTime <= 60 && sessionTime > 58">Time is running out!</span>
  </div>
  <div class="container py-4">
    <div class="d-flex align-items-center justify-content-between mb-4">
      <h2 class="text-warning fw-bold mb-0">Candidate Resume Management</h2>
      <div class="badge bg-warning text-dark px-3 py-2 shadow-sm">Administrator Portal</div>
    </div>
    
    <div class="card p-3 mb-3">
      <div class="row g-2">
        <div class="col-md-3"><input class="form-control" placeholder="Search filename" x-model="q"></div>
        <div class="col-md-3">
          <select class="form-select" x-model="status" title="Filter by status">
            <option value="">Any status</option>
            <option>pending</option>
            <option>approved</option>
            <option>rejected</option>
          </select>
        </div>
        <div class="col-md-3"><input class="form-control" placeholder="Tag" x-model="tag"></div>
        <div class="col-md-3"><button class="btn btn-primary w-100" @click="load()">Filter</button></div>
      </div>
    </div>

    <div class="card p-3" x-show="items.length">
      <div class="table-responsive">
        <table class="table table-dark table-striped align-middle admin-table-fixed">
          <thead>
            <tr>
              <th class="admin-filename-column">Filename</th>
              <th class="admin-status-column">Status</th>
              <th class="admin-tags-column">Tags</th>
              <th class="admin-created-column">Created (MYT)</th>
              <th class="admin-notes-column">Notes</th>
              <th class="admin-actions-column">Actions</th>
            </tr>
          </thead>
          <tbody id="list-body"></tbody>
        </table>
      </div>
      <!-- Pagination Controls -->
      <div class="d-flex flex-column align-items-center mt-3" x-show="totalPages > 1">
        <div class="d-flex align-items-center gap-2">
          <button class="btn btn-outline-light btn-sm px-2" @click="prevPage()" :disabled="page <= 1" title="Previous page">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-chevron-left" viewBox="0 0 16 16">
              <path fill-rule="evenodd" d="M11.354 1.646a.5.5 0 0 1 0 .708L5.707 8l5.647 5.646a.5.5 0 0 1-.708.708l-6-6a.5.5 0 0 1 0-.708l6-6a.5.5 0 0 1 .708 0z"/>
            </svg>
          </button>
          <span class="small text-nowrap">Page</span>
          <input type="number" class="form-control text-center pagination-input"
                 :value="page" @change="goToPage($event.target.value)" min="1" :max="totalPages" title="Current page">
          <span class="small text-nowrap">of <span x-text="totalPages"></span></span>
          <button class="btn btn-outline-light btn-sm px-2" @click="nextPage()" :disabled="page >= totalPages" title="Next page">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-chevron-right" viewBox="0 0 16 16">
              <path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z"/>
            </svg>
          </button>
        </div>
        <div class="small text-secondary mt-1">
          Showing <span x-text="((page-1)*perPage)+1"></span>-<span x-text="Math.min(page*perPage, items.length)"></span> of <span x-text="items.length"></span>
        </div>
      </div>
    </div>
    <div class="card p-4 text-center" x-show="!items.length">
      <h6 class="mb-2">No resumes found</h6>
      <p class="mb-0">Try adjusting your filters or ask users to consent to store resumes.</p>
    </div>
    <div x-show="detail" class="card p-4 mt-4 shadow-lg border-warning border-opacity-25 animate-fade-in" x-cloak>
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div class="d-flex align-items-center gap-3">
          <div class="bg-warning bg-opacity-10 p-2 rounded">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="text-warning" viewBox="0 0 16 16">
              <path d="M9.293 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V4.707A1 1 0 0 0 13.707 4L10 .293A1 1 0 0 0 9.293 0zM9.5 3.5v-2l3 3h-2a1 1 0 0 1-1-1zM11 8H5V7h6v1zm0-2H5V5h6v1zm-6 3h6v1H5V9zm0 2h6v1H5v-1z"/>
            </svg>
          </div>
          <h5 class="mb-0 fw-bold" x-text="detail && detail.filename ? detail.filename : '(missing)'"></h5>
        </div>
        <div class="d-flex align-items-center gap-2">
          <select class="form-select admin-status-select-modern" 
                  x-model="detail.status" 
                  title="Change status">
            <option value="pending">Pending</option>
            <option value="approved">Approved</option>
            <option value="rejected">Rejected</option>
          </select>
          <button class="btn btn-primary px-3" @click="save()">
            <i class="bi bi-check-lg me-1"></i> Save
          </button>
          <button class="btn btn-info px-3" @click="notify(detail.id)" :disabled="detail.status !== 'approved' && detail.status !== 'rejected'">
            <i class="bi bi-envelope me-1"></i> Notify
          </button>
          <button class="btn btn-outline-light" @click="detail = null">Close</button>
        </div>
      </div>
      <hr class="border-secondary opacity-25">
      <div class="mt-3">
        <h6>Text Preview</h6>
        <pre class="bg-dark p-3 admin-text-preview" x-text="detail && detail.text ? detail.text : ''"></pre>
      </div>
      <div class="mt-3">
        <h6>Comment / Notes</h6>
        <textarea class="form-control admin-notes-textarea" rows="6" x-model="detail.notes" placeholder="Add a comment..." maxlength="500"></textarea>
      </div>
      <div class="mt-3">
        <h6>Tags</h6>
        <input class="form-control" x-model="tagsInput" placeholder="comma,separated,tags">
      </div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/static/js/app.js"></script>
  <script src="/static/js/email_service.js"></script>
  <script src="/static/js/admin_panel.js"></script>
</body>
</html>
